<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
      background: #f9f9f9;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .card {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    h2 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
    }

    input,
    select,
    button {
      padding: 0.5rem;
      margin-top: 0.25rem;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }

    th {
      background: #eee;
    }
  </style>
</head>

<body>

  <div class="grid">
    <!-- Voucher Card -->
    <div class="card">
      <h2>Income / Expense Voucher</h2>
      <form id="voucherForm">
        <label>Date: <input type="date" id="dateField" name="date" required></label>
        <label>Type:
          <select name="type" required>
            <option value="Income">Income</option>
            <option value="Expense">Expense</option>
          </select>
        </label>
        <label>Amount: <input type="number" name="amount" required></label>
        <label>Description: <input type="text" name="description" required></label>
        <label>Ledger:
          <select name="ledger" required>
            <option value="">-- Select Ledger --</option>
            <option value="Education">Education</option>
            <option value="Hostel">Hostel</option>
            <option value="Health/medical">Health/medical</option>
            <option value="Kitchen">Kitchen</option>
            <option value="Transportation">Transportation</option>
            <option value="Store Stationary">Store Stationary</option>
            <option value="Shreeji Store">Shreeji Store</option>
            <option value="Office">Office</option>
            <option value="Satsang Mandal">Satsang Mandal</option>
            <option value="Shreeji Prasadam">Shreeji Prasadam</option>
            <option value="Other">Other</option>
          </select>
        </label>
        <label>Department: <input type="text" name="department" required></label>
        <button id="add-voucher" type="submit">Add Voucher</button>
      </form>
    </div>

    <!-- Add more cards here for Food Pass, Donation, etc. -->
    <!-- Example Placeholder Card -->

    <div class="card">
      <h2>Food Pass</h2>
      Content coming soon...
    </div>
    <!-- Voucher List Card -->
    <div class="card" style="grid-column: span 2;">
      <h2>Voucher List</h2>
      <table id="voucherTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Description</th>
            <th>Ledger</th>
            <th>Department</th>
            <th>Print</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
  <canvas id="voucherCanvas" width="280" height="400" style="display:none;"></canvas>


  <script>
    const form = document.getElementById('voucherForm');
    const formButton = document.querySelector('form #add-voucher')
    const tableBody = document.querySelector('#voucherTable tbody');
    // Set today's date by default
    document.getElementById('dateField').valueAsDate = new Date();


    function loadVouchers() {
      google.script.run.withSuccessHandler(function (data) {
        tableBody.innerHTML = '';
        data = JSON.parse(data);

        console.log(data);
        if (!data || !Array.isArray(data)) return;
        data.forEach(v => {
          const row = `<tr>
            <td>${v.ID}</td>
            <td>${v.Date}</td>
            <td>${v.Type}</td>
            <td>${v.Amount}</td>
            <td>${v.Description}</td>
            <td>${v.Ledger}</td>
            <td>${v.Department}</td>
            <td><button onclick='printVoucher(${JSON.stringify(JSON.stringify(v))})'>üñ®Ô∏è</button></td>
          </tr>`;
          tableBody.innerHTML += row;
        });

      }).getVouchers();
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      formButton.setAttribute('disabled', 'disabled');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      google.script.run.withSuccessHandler(function (response) {
        if (response.success) {
          form.reset();
          loadVouchers();
        }
        formButton.removeAttribute('disabled');
      }).addVoucher(data);
    });

    loadVouchers();
  </script>

  <script>
  function printVoucher(voucherJson) {
  const voucher = JSON.parse(voucherJson);
  const canvas = document.getElementById('voucherCanvas');
  const ctx = canvas.getContext('2d');

  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Settings
  ctx.fillStyle = '#000';
  ctx.font = '12px monospace';
  let y = 20;
  const lineHeight = 16;

  // Header
  ctx.font = 'bold 14px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('Shree Swaminarayan Gurukul', canvas.width / 2, y);
  y += lineHeight;

  ctx.font = '12px monospace';
  ctx.textAlign = 'left';
  y += 10;

  // Details
  const lines = [
    `ID: ${voucher.ID}`,
    `Date: ${voucher.Date}`,
    `Type: ${voucher.Type}`,
    `Amount: ‚Çπ${voucher.Amount}`,
    `Description: ${voucher.Description}`,
    `Ledger: ${voucher.Ledger}`,
    `Department: ${voucher.Department}`,
  ];

  lines.forEach(line => {
    ctx.fillText(line, 10, y);
    y += lineHeight;
  });

  // Footer
  y += 10;
  ctx.textAlign = 'center';
  ctx.fillText('üôè Thank you üôè', canvas.width / 2, y);

  // Show canvas (for preview/testing)
  canvas.style.display = 'block';

  // For printing or sending to thermal printer, you can use:
  // - `canvas.toDataURL()` to get image
  // - or connect to printer via WebUSB / WebBluetooth

  // const canvas = document.getElementById('voucherCanvas');
  const dataUrl = canvas.toDataURL();

  const win = window.open('', '', 'width=300,height=400');
  win.document.write(`
    <html><head><title>Print</title></head><body style="margin:0;">
      <img src="${dataUrl}" onload="window.print();window.onafterprint=()=>window.close();" />
    </body></html>
  `);
  win.document.close();
}



</script>


</body>

</html>